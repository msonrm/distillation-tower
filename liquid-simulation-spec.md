# 液体シミュレーション仕様書

セル・オートマトンで比重の違う2種類の液体（水と油）を表現するシミュレーション。

## 概要

- **ベース理論**: イジングモデル + カワサキダイナミクス（交換）+ グラウバーダイナミクス（相転移）
- **グリッドサイズ**: 50 × 50
- **描画**: React + Canvas API

## セルの種類

| ID | 種類 | 密度 | 沸点 | 熱伝導率 | 結合力 |
|----|------|------|------|----------|--------|
| 0 | EMPTY（空気） | 0 | ∞ | 0.01 | 0 |
| 1 | WATER（水） | 1.0 | 100° | 0.6 | 0.8 |
| 2 | OIL（油） | 0.8 | 150° | 0.2 | 0.4 |
| 3 | WATER_VAPOR（水蒸気） | 0.0001 | 100° | 0.02 | 0.1 |
| 4 | OIL_VAPOR（油蒸気） | 0.0001 | 150° | 0.02 | 0.1 |
| 5 | WALL（壁） | ∞ | ∞ | 0.8 | 1 |
| 6 | HEAT_SOURCE（熱源） | ∞ | ∞ | 1.0 | 1 |

## 界面張力マトリックス

異種セル間の反発力。値が大きいほど分離しやすい。

```
           EMPTY  WATER  OIL   W_VAP  O_VAP  WALL  HEAT
EMPTY      0.0    1.2    0.8   0.2    0.2    0.5   0.5
WATER      1.2    0.0    2.0   0.3    1.5    0.5   0.5
OIL        0.8    2.0    0.0   1.5    0.3    0.5   0.5
W_VAPOR    0.2    0.3    1.5   0.0    0.5    0.5   0.5
O_VAPOR    0.2    1.5    0.3   0.5    0.0    0.5   0.5
WALL       0.5    0.5    0.5   0.5    0.5    0.0   0.0
HEAT       0.5    0.5    0.5   0.5    0.5    0.0   0.0
```

## エネルギー計算

カワサキ交換の判定に使用するハミルトニアン：

```
E = E_重力 + E_結合 + E_界面

E_重力 = density × (GRID_SIZE - y) × gravity
       （重いものが下にあるとエネルギー低）

E_結合 = -cohesion × 0.5 × (同種隣接セル数)
       （同種が集まるとエネルギー低）

E_界面 = Σ INTERFACE_TENSION[type][neighbor] × 0.8
       （異種が隣接するとエネルギー高）
```

## 交換判定（メトロポリス法）

```
ΔE = E_交換後 - E_交換前
β = 1 / (局所温度 × 0.1 + 1)

if ΔE < 0:
    accept = 100%
else:
    accept = exp(-β × ΔE)
```

## 相転移

### 気化（液体 → 蒸気）
- 条件: T > 沸点
- 確率: min(1, (T - 沸点) / 50) × 0.3
- 効果: 潜熱吸収（温度 -20°）

### 凝縮（蒸気 → 液体）
- 条件: T < 沸点
- 確率: min(1, (沸点 - T) / 30) × 0.1
- 効果: 潜熱放出（温度 +15°）

## 熱伝導

4近傍で拡散方程式を適用：

```
ΔT = Σ (k_effective × (T_neighbor - T_self)) × 0.1
k_effective = (k_self + k_neighbor) / 2
```

温度は 0° 〜 300° にクランプ。

## 最適化手法

1. **チェッカーボード分解**: 偶数/奇数フレームで処理セルを交互に
2. **ランダムスキャン方向**: 4方向からランダム選択で偏りを防止
3. **カワサキ反復**: 1フレームあたり3回実行

## 固定パラメータ

| パラメータ | 値 |
|------------|-----|
| Speed | 3x |
| Gravity | 2.0 |
| 結合係数 | 0.5 |
| 界面係数 | 0.8 |

## 調整可能パラメータ（UI）

| パラメータ | 範囲 | デフォルト |
|------------|------|------------|
| Heat ON/OFF | ボタン | ON |
| Heat Temp | 100° - 300° | 200° |
| Room Temp | 5° - 40° | 20° |

## 初期配置

```
Row 0:        冷却壁（WALL, 10°）
Row 1-9:      空気（EMPTY）
Row 10-44:    水60%・油40%の比率で、60%の密度でランダム配置
Row 45-48:    空気（EMPTY）
Row 49:       壁 + 中央10セルが熱源
Column 0,49:  側壁（WALL, 20°）
```

## 描画色

```javascript
EMPTY:       '#1a1a2e'  // 暗い背景
WATER:       '#3498db'  // 青
OIL:         '#f39c12'  // オレンジ
WATER_VAPOR: '#85c1e9'  // 薄い青
OIL_VAPOR:   '#f9e79f'  // 薄い黄
WALL:        '#5dade2'  // 冷たい青
HEAT_SOURCE: '#e74c3c'  // 赤
```

## 未実装・検討事項

- **roomTemp**: 現在ほぼ未使用。側壁温度と連動させると効果的
- **蒸気の滞空**: 凝縮確率を下げた（0.3→0.1）が、さらなる調整の余地あり
  - 蒸気の結合力を上げる
  - 蒸気-空の界面張力を上げる
  - 冷却壁温度を上げる

## 処理フロー

```
毎フレーム:
1. updateTemperature()     - 全セルの熱伝導
2. updatePhaseTransition() - チェッカーボード片色の相転移
3. updateKawasaki() × 3    - チェッカーボード片色の交換判定
4. render()                - Canvas描画
```
